name: ci-tsqllint

on:
  pull_request:
    branches:
    - main

jobs:
  tsqllint:
    runs-on: ubuntu-22.04
    steps:
        - 
            uses: actions/checkout@v4

        -
            name: Install Dotnet
            run: |
                sudo apt-get install -y dotnet-sdk-9.0

        -
            name: Install tsqllint
            run: |
                dotnet tool install --global TSQLLint

        -
            name: run tsqllint
            id: tsqllint
            run: |
                tsqllint . --config .tsqllint >> tsqllint_output
                echo "command_output=$(cat tsqllint_output | tr '\n' '<br/>')" >> $GITHUB_OUTPUT

        - 
            name: Comment on PR with command output
            uses: actions/github-script@v6
            with:
                github-token: ${{ secrets.GITHUB_TOKEN }}
                script: |
                    github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `T-SQL Linting is complete. Please review the output below:\n\`\`\`\n" $(${{ steps.tsqllint.outputs.command_output }})"\n\`\`\``
                    });
